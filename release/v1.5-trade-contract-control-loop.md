# v1.5 Trade-Management Control Loop

Date: 2026-02-17  
Status: In Progress

## Objective

Prevent "right idea, wrong management" by making entries/exits policy-bound and mechanically auditable.

## Scope

1. Trade Contract required at entry (when enabled):
- archetype: `scalp | intraday | swing`
- invalidation type + invalidation level
- time stop timestamp
- target/trailing management intent
2. Exit FSM (reason-coded transition model):
- `hard_invalidation | time_stop | tp_hit | trail_hit | emergency_override`
3. Decision-score feedback loop:
- rolling segment metrics (`symbol x archetype x regime`)
- automatic size downshift / observation-only / block escalation
4. Counterfactual performance accounting:
- MFE/MAE
- captured R vs left-on-table R
- would-hit-2R/3R under contract

## Implementation Plan

1. Foundation:
- add `src/core/trade_contract.ts` parser + validator + archetype constraints
- add config gate: `autonomy.tradeContract.enabled`
2. Entry enforcement:
- wire `perp_place_order` validation in `src/core/tool-executor.ts`
- reject missing/invalid contract fields when enforcement is enabled
3. Exit control:
- add explicit reason-code validation for reduce-only exits
- forbid free-form discretionary exit reasons when enforcement is enabled
4. Feedback policy:
- compute rolling quality by segment from journaled scores
- feed deterministic downshift/block policy into pre-trade gate
5. Observability:
- extend `/status` summary with enforcement mode + segment throttle state

## Branch Tasks (Agile)

1. `feat/v1.5-trade-contract-foundation`
- acceptance: contract validator + tests
2. `feat/v1.5-trade-contract-entry-enforcement`
- acceptance: entry rejection on incomplete contract when enabled
3. `feat/v1.5-trade-exit-fsm-reason-codes`
- acceptance: reduce-only exits require allowed reason code path
4. `feat/v1.5-trade-score-feedback-gate`
- acceptance: deterministic size downshift/block on low-quality segments
5. `feat/v1.5-counterfactual-r-attribution`
- acceptance: journal/report includes captured vs left-on-table R

## Acceptance Criteria

1. Contract enforcement is disabled by default, deterministic when enabled.
2. No LLM call is required for contract validation or exit authorization.
3. Entry rejection messages are explicit and actionable.
4. Unit tests cover each archetype, invalidation mode, and time-stop boundary.
5. Integration tests show:
- valid contract order executes,
- invalid contract order is blocked,
- block/downshift policy activates from degraded score windows.
