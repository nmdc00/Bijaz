# Release v1.4 Planner

Date: 2026-02-17  
Base Branch: `release/v1.3`  
Release Branch: `release/v1.4`

## Scope Guardrails

- Preserve existing v1.3 behavior unless explicitly changed by a v1.4 task.
- `/delphi` must remain non-executing by default (prediction/calibration only).
- Session awareness must weight confidence/sizing, not hard-ban trading.
- One feature branch per task, one PR per branch.

## Task Branch Strategy

1. `feat/v1.4-scheduler-control-plane`
2. `feat/v1.4-escalation-notifications`
3. `feat/v1.4-session-context-classifier`
4. `feat/v1.4-session-weighting-in-scan`
5. `feat/v1.4-delphi-command-surface`
6. `feat/v1.4-delphi-storage-and-resolution`
7. `feat/v1.4-delphi-calibration-analytics`
8. `feat/v1.4-context-pack-enrichment`
9. `feat/v1.4-calibration-aware-risk-policy`
10. `feat/v1.4-integration-acceptance-tests`

## Tasks

## 1) Scheduler Control Plane
Branch: `feat/v1.4-scheduler-control-plane`

Deliverables:
- Implement a deterministic background scheduler for scan/intel/heartbeat/report jobs.
- Persist job state (`last_run_at`, `next_run_at`, status, failures, lock owner).
- Add startup recovery to resume pending schedules.

Acceptance criterion:
- Restarting gateway does not lose job schedule continuity.

Test requirement:
- Unit tests for next-run computation and lock/lease behavior.

## 2) Operator Escalation Notifications
Branch: `feat/v1.4-escalation-notifications`

Deliverables:
- Add escalation policies for actionable events only.
- Route alerts to configured channels with dedupe and cooldown.
- Add severity + reason taxonomy in emitted messages.

Acceptance criterion:
- Risk-critical incidents notify once per policy window, not spammed.

Test requirement:
- Tests for dedupe, cooldown, and severity routing.

## 3) Session Context Classifier
Branch: `feat/v1.4-session-context-classifier`

Deliverables:
- Implement `sessionContext` derivation from wall-clock and market metadata.
- Include fields: `session`, `liquidityRegime`, `qualityNotes`, `sessionWeight`.
- Expose context via scan/tool payloads.

Acceptance criterion:
- Every scan artifact includes a valid `sessionContext`.

Test requirement:
- Table-driven unit tests across UTC timestamps and weekend boundaries.

## 4) Session Weighting in Scan/Decision Pipeline
Branch: `feat/v1.4-session-weighting-in-scan`

Deliverables:
- Apply session weighting to confidence/sizing inputs.
- Keep deterministic trade path behavior explainable via trace fields.
- Log before/after confidence and sizing modifiers.

Acceptance criterion:
- Equivalent signals in different sessions produce different weighted confidence.

Test requirement:
- Pipeline tests asserting expected weighting deltas by session bucket.

## 5) `/delphi` Command Surface
Branch: `feat/v1.4-delphi-command-surface`

Deliverables:
- Add `/delphi` command namespace for prediction-only workflows.
- Add CLI parity (`thufir delphi ...`) for automation and testing.
- Add options for horizon, symbol set, count, and dry-run output.

Acceptance criterion:
- `/delphi` runs without any execution adapter dependency.

Test requirement:
- Command parsing tests for `/delphi` and CLI command variants.

## 6) `/delphi` Prediction Storage and Outcome Resolution
Branch: `feat/v1.4-delphi-storage-and-resolution`

Deliverables:
- Persist explicit predictions with confidence, horizon, and context tags.
- Implement resolver job to mark outcomes at expiry using market snapshots.
- Record resolution metadata and error states.

Acceptance criterion:
- Predictions transition cleanly: `open -> resolved_true|resolved_false|unresolved_error`.

Test requirement:
- Resolver tests with deterministic price fixtures and horizon cutoffs.

## 7) `/delphi` Calibration Analytics
Branch: `feat/v1.4-delphi-calibration-analytics`

Deliverables:
- Compute Brier score, reliability bins, confidence bias, and segment stats.
- Segment by session, regime, strategy class, horizon, and symbol.
- Add summary/report command output for operator review.

Acceptance criterion:
- Calibration report works on at least 100 resolved synthetic predictions.

Test requirement:
- Metric correctness tests against known expected values.

## 8) Context Pack Enrichment
Branch: `feat/v1.4-context-pack-enrichment`

Deliverables:
- Add richer scan context bundle (regime, execution quality, event, portfolio state).
- Ensure context fields are available to reasoning and audit artifacts.
- Add safeguards for missing upstream data (graceful defaults).

Acceptance criterion:
- Scan trace shows full context pack without breaking on partial data.

Test requirement:
- Integration tests with sparse/missing context providers.

## 9) Calibration-Aware Risk Policy
Branch: `feat/v1.4-calibration-aware-risk-policy`

Deliverables:
- Add policy hooks that reduce size or block segments with poor calibration.
- Support minimum sample thresholds before any calibration-based scaling.
- Emit explicit policy reasons in decision traces.

Acceptance criterion:
- Underperforming segments are automatically down-weighted once thresholds are met.

Test requirement:
- Policy tests for thresholds, fallback behavior, and reason codes.

## 10) Integration and Acceptance Harness
Branch: `feat/v1.4-integration-acceptance-tests`

Deliverables:
- Add end-to-end acceptance tests for scheduler, session context, `/delphi`, and calibration risk hooks.
- Add release checklist and smoke test script for v1.4.
- Add migration verification for any schema changes.

Acceptance criterion:
- Full v1.4 acceptance suite passes on `release/v1.4`.

Test requirement:
- Deterministic integration suite in `tests/` with fixtures for session + prediction lifecycle.

## Multi-Agent Worktree Plan

Use one worktree per agent, one branch per task.

Suggested allocation:
1. Agent A: tasks 1, 2
2. Agent B: tasks 3, 4
3. Agent C: tasks 5, 6
4. Agent D: tasks 7, 9
5. Agent E: tasks 8, 10

Worktree creation template:

```bash
~/.codex/skills/git-multi-worktree-sprint/scripts/create_worktree.sh \
  --repo /home/nmcdc/projects/Thufir-Hawat \
  --base release/v1.4 \
  --branch feat/v1.4-<task-slug> \
  --agent agent-<id> \
  --root /tmp/thufir-worktrees
```

Branch validation before PR:

```bash
/home/nmcdc/.codex/skills/agile-sprint-branching/scripts/check_feature_branches.sh \
  --base origin/release/v1.4 \
  --pattern 'origin/feat/v1.4-*'
```

## Merge Order

1. `feat/v1.4-scheduler-control-plane`
2. `feat/v1.4-session-context-classifier`
3. `feat/v1.4-session-weighting-in-scan`
4. `feat/v1.4-delphi-command-surface`
5. `feat/v1.4-delphi-storage-and-resolution`
6. `feat/v1.4-delphi-calibration-analytics`
7. `feat/v1.4-context-pack-enrichment`
8. `feat/v1.4-calibration-aware-risk-policy`
9. `feat/v1.4-escalation-notifications`
10. `feat/v1.4-integration-acceptance-tests`

## Exit Criteria for v1.4

- All v1.4 task branches merged into `release/v1.4`.
- Scheduler + escalation flows run under gateway with no duplicate job execution.
- `sessionContext` appears in scan artifacts and affects scoring.
- `/delphi` emits, stores, resolves, and reports predictions with calibration metrics.
- Calibration-aware risk policy works only after minimum sample thresholds.
- Full test suite plus v1.4 acceptance suite is green.

## Follow-On Epic (Develop)

Latency optimization follow-on work for `develop` is tracked separately:

- `release/v1.4-latency-epic.md`
- `release/v1.4-latency-planner.md`
- `release/v1.4-latency-checklist.md`

This keeps the shipped v1.4 release scope stable while allowing targeted hot-path
improvements in parallel branches.
